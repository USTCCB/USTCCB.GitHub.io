// GitHub 配置
const GITHUB_CONFIG = {
    username: 'USTCCB',
    repo: 'USTCCB.github.io',
    branch: 'main'
};

// 直接在前端存储 token
localStorage.setItem('github_token', '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');

// 简单的获取 token 函数
async function getGitHubToken() {
    return localStorage.getItem('github_token');
}

// 获取 GitHub 文件列表
async function fetchGitHubFiles() {
    try {
        const token = await getGitHubToken();
        let response = await fetch(
            `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/shared_files`,
            {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );
        
        if (response.status === 404) {
            // 如果目录不存在，创建它
            await createDirectory(token);
            return [];
        }
        
        const data = await response.json();
        if (Array.isArray(data)) {
            return data.filter(item => item.type === 'file');
        }
        return [];
    } catch (error) {
        console.error('获取文件列表失败:', error);
        showNotification('获取文件列表失败');
        return [];
    }
}

// 创建目录
async function createDirectory(token) {
    try {
        await fetch(
            `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/shared_files/.gitkeep`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'Create shared_files directory',
                    content: btoa(''),
                    branch: GITHUB_CONFIG.branch
                })
            }
        );
    } catch (error) {
        console.error('创建目录失败:', error);
    }
}

// 上传文件到 GitHub
async function uploadToGitHub(file, content) {
    const token = await getGitHubToken();
    const path = `shared_files/${file.name}`;
    let base64Content;
    
    // 根据内容类型处理 base64 编码
    if (typeof content === 'string') {
        // 文本内容
        base64Content = btoa(unescape(encodeURIComponent(content)));
    } else {
        // 文件内容
        base64Content = content.split(',')[1];
    }
    
    try {
        const response = await fetch(
            `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${path}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Upload ${file.name}`,
                    content: base64Content,
                    branch: GITHUB_CONFIG.branch
                })
            }
        );
        
        if (!response.ok) {
            throw new Error(await response.text());
        }
        return await response.json();
    } catch (error) {
        console.error('上传文件失败:', error);
        throw error;
    }
}

// 显示错误信息
function showError(error) {
    showNotification(`错误: ${error.message || '操作失败'}`, 'error');
}

// 显示通知
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    if (notification) {
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    } else {
        console.log(message);  // 如果没有notification元素，就用console.log
    }
}

// 下载文件
async function downloadFile(url, filename) {
    try {
        const token = await getGitHubToken();
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${token}`
            }
        });
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(downloadUrl);
        document.body.removeChild(a);
    } catch (error) {
        console.error('下载文件失败:', error);
        showNotification('下载文件失败', 'error');
    }
}

// 删除文件
async function deleteFile(path, sha) {
    try {
        const token = await getGitHubToken();
        const response = await fetch(
            `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${path}`,
            {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Delete ${path}`,
                    sha: sha,
                    branch: GITHUB_CONFIG.branch
                })
            }
        );
        
        if (!response.ok) {
            throw new Error(await response.text());
        }
        
        showNotification('文件删除成功', 'success');
        return true;
    } catch (error) {
        console.error('删除文件失败:', error);
        showNotification('删除文件失败', 'error');
        return false;
    }
}

// 示例HTML结构
/*
<div id="notification" class="notification" style="display: none;"></div>
<input type="file" id="fileInput" />
<button onclick="handleFileUpload()">上传文件</button>
<div id="fileList"></div>
*/

// 示例CSS
/*
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    border-radius: 4px;
    display: none;
}

.notification.info {
    background-color: #2196F3;
    color: white;
}

.notification.error {
    background-color: #f44336;
    color: white;
}

.notification.success {
    background-color: #4CAF50;
    color: white;
}
*/

// 文件上传处理函数
async function handleFileUpload() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('请选择要上传的文件', 'error');
        return;
    }
    
    try {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                await uploadToGitHub(file, e.target.result);
                showNotification('文件上传成功', 'success');
                // 刷新文件列表
                displayFiles();
            } catch (error) {
                showError(error);
            }
        };
        reader.readAsDataURL(file);
    } catch (error) {
        showError(error);
    }
}

// 显示文件列表
async function displayFiles() {
    const fileList = document.getElementById('fileList');
    const files = await fetchGitHubFiles();
    
    fileList.innerHTML = '';
    files.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.innerHTML = `
            <span>${file.name}</span>
            <button onclick="downloadFile('${file.download_url}', '${file.name}')">下载</button>
            <button onclick="deleteFile('shared_files/${file.name}', '${file.sha}')">删除</button>
        `;
        fileList.appendChild(fileDiv);
    });
}

// 页面加载时初始化显示
document.addEventListener('DOMContentLoaded', () => {
    displayFiles();
});
